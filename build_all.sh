#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∫–∏ –≤—Å–µ—Ö Python –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –≤ EXE
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏–∑ ./env
# –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–æ–∫ lab**/main.py

set +e  # –ù–µ –≤—ã—Ö–æ–¥–∏–º –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

echo "üî® –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ –≤—Å–µ—Ö EXE —Ñ–∞–π–ª–æ–≤..."
echo ""

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source ./env/bin/activate

echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PyInstaller –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ PyInstaller..."
pip install --quiet pyinstaller 2>/dev/null

echo ""

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–±–æ—Ä–æ–∫ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p dist
mkdir -p build
mkdir -p specs

# –°—á—ë—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω—ã—Ö —Å–±–æ—Ä–æ–∫
BUILT=0
FAILED=0
TOTAL=0

# –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ main.py —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–∞—Ö lab*
for main_file in lab*/main.py; do
    if [ -f "$main_file" ]; then
        lab_dir=$(dirname "$main_file")
        lab_name=$(basename "$lab_dir")
        
        echo "üî® –°–æ–±–∏—Ä–∞—é $lab_name..."
        ((TOTAL++))
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º PyInstaller
        pyinstaller \
            --onefile \
            --windowed \
            --name "$lab_name" \
            --distpath "./dist" \
            --workpath "./build/$lab_name" \
            --specpath "./specs" \
            --noupx \
            "$main_file" > /dev/null 2>&1
        
        STATUS=$?
        if [ $STATUS -eq 0 ]; then
            echo "   ‚úÖ –£—Å–ø–µ—à–Ω–æ!"
            ((BUILT++))
        else
            echo "   ‚ùå –û—à–∏–±–∫–∞ (–∫–æ–¥: $STATUS)"
            ((FAILED++))
        fi
    fi
done

echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±–æ—Ä–∫–∏:"
echo "   üì¶ –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: $TOTAL"
echo "   ‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω–æ: $BUILT"
if [ $FAILED -gt 0 ]; then
    echo "   ‚ùå –û—à–∏–±–æ–∫: $FAILED"
fi
echo "   üìÅ –†–∞–∑–º–µ—Ä: $(du -sh ./dist 2>/dev/null | cut -f1)"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

# –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üìã –°–ø–∏—Å–æ–∫ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö EXE —Ñ–∞–π–ª–æ–≤:"
echo ""
ls -lh ./dist/ | awk 'NR>1 {printf "   %s (%s)\n", $9, $5}'
echo ""
echo "üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏—è:"
echo "  - –ï—Å–ª–∏ SmartScreen –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã, —Å–∫–∞—á–∏–≤–∞–π—Ç–µ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä"
echo "  - –ò–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ —Å–≤–æ–π—Å—Ç–≤–∞ (Properties ‚Üí Unblock)"
echo "  - –î–ª—è –ø–æ–ª–Ω–æ–π –∑–∞—â–∏—Ç—ã –æ—Ç SmartScreen –∫—É–ø–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫–æ–¥–∞"
